<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Calendarify - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A2E29;
            color: #E0E0E0;
        }
        .primary-button {
            background-color: #34D399;
            color: #1A2E29;
        }
        .primary-button:hover {
            background-color: #2BB98A;
        }
        .secondary-button {
            border: 1px solid #34D399;
            color: #34D399;
        }
        .secondary-button:hover {
            background-color: #34D399;
            color: #1A2E29;
        }
        .date-picker-day.selected {
            background-color: #34D399;
            color: #1A2E29;
        }
        .time-slot.selected {
            background-color: #34D399;
            color: #1A2E29;
            border-color: #34D399;
            font-weight: bold;
        }
        .nav-link {
            color: #A3B3AF;
        }
        .nav-link:hover {
            color: #E0E0E0;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background-color: #2C4A43;
        }
        .calendar-day.today {
            background-color: #F97316; /* Orange color */
            color: #1A2E29;
            font-weight: bold;
        }
        .calendar-day.selected {
            background-color: #34D399; /* Theme green color */
            color: #1A2E29;
            font-weight: bold;
        }
        .calendar-day.has-events {
            position: relative;
        }
        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background-color: #34D399;
            border-radius: 50%;
        }
        .calendar-day.unavailable {
            color: #555;
            pointer-events: none;
            opacity: 0.5;
        }
        /* Custom scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1A2E29;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #2C4A43;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #34D399;
        }
        
        /* Animation styles */
        .main-container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
            position: relative;
        }
        
        .main-container.extended {
            max-width: 8xl;
            transform: translateX(-140px);
        }
        
        .time-slots-container {
            opacity: 0;
            transform: translateX(-260px) scale(0.8);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            position: absolute;
            right: -260px;
            top: -2rem;
            bottom: -2rem;
            width: 260px;
            padding: 1rem;
            border-radius: 0 0.75rem 0.75rem 0;
            background-color: #1E3A34;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        
        .time-slots-container.show {
            opacity: 1;
            transform: translateX(0) scale(1);
            max-height: none;
        }
        
        .main-content {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .calendar-section {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-height: 400px;
        }
        
        .time-slot {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            background-color: #2C4A43;
            border: 1px solid #34D399;
            color: #E0E0E0;
        }
        
        .time-slot:hover {
            background-color: #34D399;
            color: #1A2E29;
        }
        
        .time-slot:nth-child(1) { transition-delay: 0.1s; }
        .time-slot:nth-child(2) { transition-delay: 0.15s; }
        .time-slot:nth-child(3) { transition-delay: 0.2s; }
        .time-slot:nth-child(4) { transition-delay: 0.25s; }
        .time-slot:nth-child(5) { transition-delay: 0.3s; }
        .time-slot:nth-child(6) { transition-delay: 0.35s; }
        .time-slot:nth-child(7) { transition-delay: 0.4s; }
        .time-slot:nth-child(8) { transition-delay: 0.45s; }
        .time-slot:nth-child(9) { transition-delay: 0.5s; }
        .time-slot:nth-child(10) { transition-delay: 0.55s; }
        .time-slot:nth-child(11) { transition-delay: 0.6s; }
        .time-slot:nth-child(12) { transition-delay: 0.65s; }
        .time-slot:nth-child(13) { transition-delay: 0.7s; }
        .time-slot:nth-child(14) { transition-delay: 0.75s; }
        .time-slot:nth-child(15) { transition-delay: 0.8s; }
        .time-slot:nth-child(16) { transition-delay: 0.85s; }
        .time-slot:nth-child(17) { transition-delay: 0.9s; }
        .time-slot:nth-child(18) { transition-delay: 0.95s; }
        .time-slot:nth-child(19) { transition-delay: 1s; }
        .time-slot:nth-child(20) { transition-delay: 1.05s; }
        .time-slot:nth-child(21) { transition-delay: 1.1s; }
        .time-slot:nth-child(22) { transition-delay: 1.15s; }
        .time-slot:nth-child(23) { transition-delay: 1.2s; }
        .time-slot:nth-child(24) { transition-delay: 1.25s; }
        .time-slot:nth-child(25) { transition-delay: 1.3s; }
        .time-slot:nth-child(26) { transition-delay: 1.35s; }
        .time-slot:nth-child(27) { transition-delay: 1.4s; }
        .time-slot:nth-child(28) { transition-delay: 1.45s; }
        .time-slot:nth-child(29) { transition-delay: 1.5s; }
        .time-slot:nth-child(30) { transition-delay: 1.55s; }
        .time-slot:nth-child(31) { transition-delay: 1.6s; }
        .time-slot:nth-child(32) { transition-delay: 1.65s; }
        
        /* Modal styling */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: #1E3A34;
            border: 1px solid #2C4A43;
            border-radius: 12px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-[#111f1c] py-4 px-6 md:px-12">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <span class="material-icons-outlined text-3xl text-[#34D399] mr-2">calendar_month</span>
                <h1 class="text-2xl font-bold text-white">Calendarify</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <a class="nav-link" href="/individuals">Individuals</a>
                <a class="nav-link" href="/teams">Teams</a>
                <a class="nav-link" href="/enterprise">Enterprise</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button class="primary-button px-6 py-2 rounded-lg font-semibold text-sm">Sign up</button>
                <button class="text-sm nav-link">Log In</button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 md:py-16">
        <div class="bg-[#1E3A34] p-8 rounded-xl shadow-2xl w-full max-w-6xl mx-auto main-container" id="mainContainer">
            <div class="flex flex-col lg:flex-row lg:space-x-8 main-content" id="mainContent">
                <div class="lg:w-1/2">
                    <p class="text-sm text-gray-400">Book a meeting with <span id="username" class="text-[#34D399]"></span></p>
                    <h2 id="eventTitle" class="text-3xl font-bold text-white mt-1 mb-4"></h2>
                    <div class="flex items-center text-gray-400 mb-2">
                        <span class="material-icons-outlined mr-2">schedule</span>
                        <span>Manage your availability</span>
                    </div>
                    <div class="flex items-center text-gray-400">
                        <span class="material-icons-outlined mr-2">videocam</span>
                        <span>Set up your meeting preferences</span>
                    </div>
                </div>
                <div class="lg:w-1/2 mt-8 lg:mt-0 relative" id="calendarSection">
                    <div class="calendar-section" id="calendarContainer">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">Select a Date</h3>
                        <div class="bg-[#1A2E29] p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prevMonth" class="p-2 rounded-full hover:bg-[#2C4A43]">
                                    <span class="material-icons-outlined text-gray-300">chevron_left</span>
                                </button>
                                <div id="currentMonth" class="text-lg font-medium text-white"></div>
                                <button id="nextMonth" class="p-2 rounded-full hover:bg-[#2C4A43]">
                                    <span class="material-icons-outlined text-gray-300">chevron_right</span>
                                </button>
                            </div>
                            <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>
                        </div>
                        <button class="primary-button w-full py-3 rounded-lg font-semibold mt-6" id="confirmButton" style="opacity: 0.5; pointer-events: none;">
                            Confirm
                        </button>
                    </div>
                    <div id="timeSlots" class="time-slots-container">
                        <div class="flex flex-col h-full">
                            <div class="pt-4 pb--4">
                                <h4 id="selectedDate" class="text-lg font-medium text-white mb-4 text-center"></h4>
                            </div>
                            <div class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar rounded-lg mb-4" id="timeSlotsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Booking Details Modal -->
    <div id="bookingModal" class="modal-backdrop fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-white">Complete Your Booking</h3>
                <button id="closeBookingModal" class="text-gray-400 hover:text-white">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Booking Summary -->
                <div class="bg-[#1A2E29] p-4 rounded-lg">
                    <h4 class="text-lg font-medium text-white mb-2">Booking Summary</h4>
                    <div class="text-gray-300">
                        <p><strong>Event:</strong> <span id="modalEventTitle"></span></p>
                        <p><strong>Date:</strong> <span id="modalEventDate"></span></p>
                        <p><strong>Time:</strong> <span id="modalEventTime"></span></p>
                        <p><strong>Duration:</strong> <span id="modalEventDuration"></span></p>
                    </div>
                </div>

                <!-- Required Fields -->
                <div id="requiredFieldsSection">
                    <h4 class="text-lg font-medium text-white mb-4">Required Information</h4>
                    <div class="space-y-4">
                        <div id="nameField" class="hidden">
                            <label class="block text-[#A3B3AF] text-sm font-medium mb-2">Name *</label>
                            <input type="text" id="bookingName" class="w-full bg-[#19342e] border border-[#2C4A43] text-[#E0E0E0] rounded-lg px-4 py-3 focus:border-[#34D399] focus:ring-2 focus:ring-[#34D399] transition-colors" placeholder="Enter your name">
                        </div>
                        <div id="emailField" class="hidden">
                            <label class="block text-[#A3B3AF] text-sm font-medium mb-2">Email *</label>
                            <input type="email" id="bookingEmail" class="w-full bg-[#19342e] border border-[#2C4A43] text-[#E0E0E0] rounded-lg px-4 py-3 focus:border-[#34D399] focus:ring-2 focus:ring-[#34D399] transition-colors" placeholder="Enter your email">
                        </div>
                        <div id="phoneField" class="hidden">
                            <label class="block text-[#A3B3AF] text-sm font-medium mb-2">Phone Number</label>
                            <input type="tel" id="bookingPhone" class="w-full bg-[#19342e] border border-[#2C4A43] text-[#E0E0E0] rounded-lg px-4 py-3 focus:border-[#34D399] focus:ring-2 focus:ring-[#34D399] transition-colors" placeholder="Enter your phone number">
                        </div>
                        <div id="companyField" class="hidden">
                            <label class="block text-[#A3B3AF] text-sm font-medium mb-2">Company</label>
                            <input type="text" id="bookingCompany" class="w-full bg-[#19342e] border border-[#2C4A43] text-[#E0E0E0] rounded-lg px-4 py-3 focus:border-[#34D399] focus:ring-2 focus:ring-[#34D399] transition-colors" placeholder="Enter your company name">
                        </div>
                    </div>
                </div>

                <!-- Additional Questions -->
                <div id="questionsSection" class="hidden">
                    <h4 class="text-lg font-medium text-white mb-4">Additional Questions</h4>
                    <div id="questionsContainer" class="space-y-4">
                        <!-- Questions will be dynamically added here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-4">
                    <button id="cancelBooking" class="secondary-button px-6 py-3 rounded-lg font-semibold">
                        Cancel
                    </button>
                    <button id="confirmBooking" class="primary-button px-6 py-3 rounded-lg font-semibold">
                        Confirm Booking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-8 text-center">
        <p class="text-xs text-gray-500">
            This is a demo application and is not intended for actual use. All functionality is for demonstration purposes only.
        </p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[TEMP-DEBUG] Booking page loaded');
            const parts = window.location.pathname.split('/').filter(Boolean);
            let display = '';
            let slug = '';
            if (parts.length >= 3 && parts[0] === 'booking') {
                display = decodeURIComponent(parts[1]);
                slug = parts[2];
            } else {
                const params = new URLSearchParams(window.location.search);
                display = params.get('user') || '';
                slug = params.get('event') || '';
            }
            if (!slug || !display) {
                window.location.replace('/');
                return;
            }
            document.getElementById('username').textContent = display;
            console.log('[TEMP-DEBUG] Booking for', { display, slug });

            window.API_URL = 'http://localhost:3001/api';
            let event;
            try {
                console.log('[TEMP-DEBUG] Fetching event type info');
                const res = await fetch(`${API_URL}/event-types/slug/${slug}`);
                if (!res.ok) throw new Error('not found');
                event = await res.json();
                console.log('[DEBUG] Event data from API:', event);
                
                if (!event) {
                    document.body.innerHTML = '<div class="text-center mt-20 text-red-500">Invalid event link</div>';
                    return;
                }
            } catch (e) {
                // Fallback to local data if API request fails
                console.log('[TEMP-DEBUG] API failed, using fallback data');
                event = {
                    title: 'Demo Meeting',
                    name: 'Demo Meeting',
                    duration: 30,
                    bufferBefore: 0,
                    bufferAfter: 0,
                    advanceNotice: 0,
                    questions: '',
                    requiredFields: { name: true, email: true, phone: false, company: false }
                };
            }

            try {
                console.log('[TEMP-DEBUG] Fetching host state');
                const resState = await fetch(`${API_URL}/users/display/${display}/state`);
                if (resState.ok) {
                    const state = await resState.json();
                    Object.entries(state).forEach(([k,v]) => {
                        localStorage.setItem(k, JSON.stringify(v));
                    });
                    
                    // Try to get the complete event type data from the host's state
                    const eventTypes = JSON.parse(localStorage.getItem('calendarify-event-types') || '[]');
                    const completeEventType = eventTypes.find(et => et.slug === slug);
                    if (completeEventType) {
                        console.log('[DEBUG] Found complete event type in host state:', completeEventType);
                        // Merge the complete data with the basic API data
                        event = { ...event, ...completeEventType };
                        console.log('[DEBUG] Merged event data:', event);
                    }
                }
            } catch (e) {
                console.log('[TEMP-DEBUG] Failed to refresh host state', e);
            }

            // Ensure we have default weekly hours if none exist
            const weeklyHours = JSON.parse(localStorage.getItem('calendarify-weekly-hours') || '{}');
            if (Object.keys(weeklyHours).length === 0) {
                const defaultHours = {
                    monday: { start: '09:00 AM', end: '05:00 PM' },
                    tuesday: { start: '09:00 AM', end: '05:00 PM' },
                    wednesday: { start: '09:00 AM', end: '05:00 PM' },
                    thursday: { start: '09:00 AM', end: '05:00 PM' },
                    friday: { start: '09:00 AM', end: '05:00 PM' }
                };
                localStorage.setItem('calendarify-weekly-hours', JSON.stringify(defaultHours));
                console.log('[TEMP-DEBUG] Set default weekly hours:', defaultHours);
            }

            document.getElementById('eventTitle').textContent = `Book: ${event.title || event.name}`;

            const eventDuration = parseInt(event.duration) || 30;
            const bufferBefore = parseInt(event.bufferBefore) || 0;
            const bufferAfter = parseInt(event.bufferAfter) || 0;
            const advanceNotice = parseInt(event.advanceNotice) || 0;
            console.log('[TEMP-DEBUG] Event settings', { eventDuration, bufferBefore, bufferAfter, advanceNotice });
            
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTime = null;
            let timeSlots = {};

            function formatDate(date) {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            function formatTime(time) {
                return new Date(`2000-01-01T${time}`).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }

            function parseTime(str) {
                const [time, ap] = str.trim().split(' ');
                let [h, m] = time.split(':').map(Number);
                if (ap && ap.toUpperCase() === 'PM' && h !== 12) h += 12;
                if (ap && ap.toUpperCase() === 'AM' && h === 12) h = 0;
                return { h, m };
            }

            function generateSlotsInRange(startStr, endStr, date) {
                console.log('[TEMP-DEBUG] generateSlotsInRange', { startStr, endStr, date });
                const { h: startH, m: startM } = parseTime(startStr);
                const { h: endH, m: endM } = parseTime(endStr);

                console.log('[TEMP-DEBUG] Parsed times:', { startH, startM, endH, endM });

                const dayStart = startH * 60 + startM;
                const dayEnd = endH * 60 + endM;

                console.log('[TEMP-DEBUG] Day minutes:', { dayStart, dayEnd });

                // Apply buffer times
                const effectiveStart = dayStart + bufferBefore;
                const effectiveEnd = dayEnd - bufferAfter - eventDuration;
                
                console.log('[TEMP-DEBUG] Effective times:', { effectiveStart, effectiveEnd, bufferBefore, bufferAfter, eventDuration });
                
                if (effectiveEnd < effectiveStart) {
                    console.log('[TEMP-DEBUG] No slots available - effective end before start');
                    return [];
                }

                const step = 15;
                let currentMinutes = effectiveStart;
                const slots = [];
                
                while (currentMinutes <= effectiveEnd) {
                    const slot = new Date(date);
                    slot.setHours(Math.floor(currentMinutes / 60), currentMinutes % 60, 0, 0);

                    // Apply advance notice
                    if (advanceNotice > 0) {
                        const earliestAllowed = new Date(Date.now() + advanceNotice * 60000);
                        if (slot < earliestAllowed) {
                            currentMinutes += step;
                            continue;
                        }
                    } else if (date.toDateString() === new Date().toDateString()) {
                        // If no advance notice, don't show past times for today
                        if (slot <= new Date()) {
                            currentMinutes += step;
                            continue;
                        }
                    }

                    // Exclude times that have already been booked (respect buffer)
                    let booked = {};
                    try {
                        booked = JSON.parse(localStorage.getItem('calendarify-booked-slots') || '{}');
                    } catch {}
                    const busy = booked[event.slug] || [];
                    const candidateStart = new Date(slot.getTime() - bufferBefore * 60000);
                    const candidateEnd = new Date(slot.getTime() + eventDuration * 60000 + bufferAfter * 60000);
                    const conflict = busy.some(b => {
                        const bStart = new Date(b.start);
                        const bEnd = new Date(b.end);
                        const bStartBuf = new Date(bStart.getTime() - (b.bufferBefore || 0) * 60000);
                        const bEndBuf = new Date(bEnd.getTime() + (b.bufferAfter || 0) * 60000);
                        return candidateStart < bEndBuf && candidateEnd > bStartBuf;
                    });
                    if (!conflict) {
                        const timeStr = slot.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                        slots.push(timeStr);
                        console.log('[TEMP-DEBUG] Added slot', timeStr);
                    } else {
                        console.log('[TEMP-DEBUG] Skipping booked slot at', slot);
                    }
                    currentMinutes += step;
                }
                
                console.log('[TEMP-DEBUG] Total slots generated:', slots.length);
                return slots;
            }

            async function generateTimeSlots(date) {
                try {
                    const res = await fetch(`${API_URL}/event-types/${event.slug}/slots?date=${date.toISOString().split('T')[0]}`);
                    if (res.ok) {
                        const data = await res.json();
                        return data.map(iso => formatTime(iso.substring(11,16)));
                    }
                } catch (e) { console.log('slot fetch failed', e); }

                const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                const dayKey = dayNames[date.getDay()];

                console.log('[TEMP-DEBUG] generateTimeSlots for day:', dayKey);

                const overrides = JSON.parse(localStorage.getItem('calendarify-overrides') || '{}');
                const override = overrides[date.toISOString().split('T')[0]];
                if (override) {
                    console.log('[TEMP-DEBUG] Found override for date:', override);
                    if (!override.available) return [];
                    if (override.timeSlots && override.timeSlots.length > 0) {
                        let list = [];
                        override.timeSlots.forEach(t => {
                            list = list.concat(generateSlotsInRange(t.start, t.end, date));
                        });
                        return list;
                    }
                }

                const weekly = JSON.parse(localStorage.getItem('calendarify-weekly-hours') || '{}');
                console.log('[TEMP-DEBUG] Weekly hours data:', weekly);
                const range = weekly[dayKey] || { start: '09:00 AM', end: '05:00 PM' };
                console.log('[TEMP-DEBUG] Using time range:', range);
                return generateSlotsInRange(range.start, range.end, date);
            }

            async function updateTimeSlots() {
                console.log('[TEMP-DEBUG] updateTimeSlots for', selectedDate);
                const container = document.getElementById('timeSlotsContainer');
                const dateHeader = document.getElementById('selectedDate');
                const timeSlotsDiv = document.getElementById('timeSlots');
                const confirmButton = document.getElementById('confirmButton');
                const mainContainer = document.getElementById('mainContainer');
                
                if (!selectedDate) {
                    timeSlotsDiv.classList.remove('show');
                    mainContainer.classList.remove('extended');
                    confirmButton.style.opacity = '0.5';
                    confirmButton.style.pointerEvents = 'none';
                    return;
                }

                dateHeader.textContent = formatDate(selectedDate);
                container.innerHTML = '';

                const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                const dayAvail = JSON.parse(localStorage.getItem('calendarify-day-availability') || '{}');
                const isDayOff = dayAvail[dayNames[selectedDate.getDay()]] === false;

                console.log('[TEMP-DEBUG] Day availability check:', {
                    selectedDate: selectedDate.toDateString(),
                    dayOfWeek: selectedDate.getDay(),
                    dayName: dayNames[selectedDate.getDay()],
                    dayAvail,
                    isDayOff,
                    isPast: selectedDate < new Date(new Date().setHours(0,0,0,0)),
                    isWeekend: selectedDate.getDay() === 0 || selectedDate.getDay() === 6
                });

                if (selectedDate < new Date(new Date().setHours(0,0,0,0)) || selectedDate.getDay() === 0 || selectedDate.getDay() === 6 || isDayOff) {
                    console.log('[TEMP-DEBUG] No availability - date filtered out');
                    container.innerHTML = '<p class="text-center text-gray-500">No availability</p>';
                    confirmButton.style.opacity = '0.5';
                    confirmButton.style.pointerEvents = 'none';
                } else {
                    let timeSlots = await generateTimeSlots(selectedDate);
                    console.log('[TEMP-DEBUG] Generated slots', timeSlots);

                    if (timeSlots.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500">No availability</p>';
                        confirmButton.style.opacity = '0.5';
                        confirmButton.style.pointerEvents = 'none';
                    } else {
                        timeSlots.forEach(time => {
                            const button = document.createElement('button');
                            button.className = 'time-slot w-full text-center py-3 rounded-lg transition-all duration-150 font-medium';
                            button.textContent = time;
                            // Force visibility for debugging
                            button.style.opacity = '1';
                            button.style.transform = 'translateY(0)';
                            button.style.visibility = 'visible';
                            button.addEventListener('click', () => {
                                container.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
                                button.classList.add('selected');
                                selectedTime = time;
                                confirmButton.style.opacity = '1';
                                confirmButton.style.pointerEvents = 'auto';
                            });
                            container.appendChild(button);
                        });
                    }
                }

                // Show time slots with animation and move entire container left
                timeSlotsDiv.classList.add('show');
                mainContainer.classList.add('extended');
                
                // Debug: Check container visibility
                console.log('[TEMP-DEBUG] Time slots container classes:', timeSlotsDiv.className);
                console.log('[TEMP-DEBUG] Time slots container computed style:', window.getComputedStyle(timeSlotsDiv).display);
                console.log('[TEMP-DEBUG] Main container classes:', mainContainer.className);
                
                // Animate time slots appearing
                setTimeout(() => {
                    container.querySelectorAll('.time-slot').forEach(slot => {
                        slot.classList.add('show');
                    });
                }, 100);
                
                // Debug: Check if slots are actually in the DOM
                console.log('[TEMP-DEBUG] Time slots in DOM:', container.querySelectorAll('.time-slot').length);
                console.log('[TEMP-DEBUG] First slot element:', container.querySelector('.time-slot'));
            }

            function buildCalendar() {
                console.log('[TEMP-DEBUG] buildCalendar for', currentDate);
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                
                document.getElementById('currentMonth').textContent = 
                    firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const calendarEl = document.getElementById('calendar');
                calendarEl.innerHTML = '';
                
                // Add day names
                dayNames.forEach(n => {
                    const div = document.createElement('div');
                    div.textContent = n;
                    div.className = 'text-sm text-gray-400 py-2';
                    calendarEl.appendChild(div);
                });
                
                // Add empty cells for days before the first day of the month
                for (let i = 0; i < firstDay.getDay(); i++) {
                    const div = document.createElement('div');
                    div.className = 'calendar-day';
                    calendarEl.appendChild(div);
                }
                
                // Add days of the month
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const div = document.createElement('div');
                    div.textContent = day;

                    const currentDay = new Date(year, month, day);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const isPast = currentDay < today;
                    const isWeekend = currentDay.getDay() === 0 || currentDay.getDay() === 6;

                    div.className = 'calendar-day' + (isPast || isWeekend ? ' unavailable' : ' cursor-pointer');

                    if (currentDay.toDateString() === new Date().toDateString()) {
                        div.classList.add('today');
                    }

                    if (selectedDate && currentDay.toDateString() === selectedDate.toDateString()) {
                        div.classList.add('selected');
                    }

                    if (!isPast && !isWeekend) {
                        div.addEventListener('click', () => {
                            calendarEl.querySelectorAll('.calendar-day').forEach(day => {
                                day.classList.remove('selected');
                            });
                            div.classList.add('selected');
                            selectedDate = new Date(year, month, day);
                            updateTimeSlots();
                        });
                    }

                    calendarEl.appendChild(div);
                }
            }

            function showBookingModal() {
                // Debug: Log the event data to see what we're working with
                console.log('[DEBUG] Event data:', event);
                console.log('[DEBUG] Required fields:', event.requiredFields);
                console.log('[DEBUG] Questions:', event.questions);
                
                // Populate modal with booking details
                document.getElementById('modalEventTitle').textContent = event.title || event.name;
                document.getElementById('modalEventDate').textContent = formatDate(selectedDate);
                document.getElementById('modalEventTime').textContent = selectedTime;
                document.getElementById('modalEventDuration').textContent = `${eventDuration} minutes`;

                // Show/hide required fields based on actual event settings
                const requiredFields = event.requiredFields || { name: false, email: false, phone: false, company: false };
                console.log('[DEBUG] Using required fields:', requiredFields);
                
                // Reset all fields to hidden first
                document.getElementById('nameField').classList.add('hidden');
                document.getElementById('emailField').classList.add('hidden');
                document.getElementById('phoneField').classList.add('hidden');
                document.getElementById('companyField').classList.add('hidden');
                
                // Show only the fields that are required
                if (requiredFields.name) {
                    console.log('[DEBUG] Showing name field');
                    document.getElementById('nameField').classList.remove('hidden');
                }
                if (requiredFields.email) {
                    console.log('[DEBUG] Showing email field');
                    document.getElementById('emailField').classList.remove('hidden');
                }
                if (requiredFields.phone) {
                    console.log('[DEBUG] Showing phone field');
                    document.getElementById('phoneField').classList.remove('hidden');
                }
                if (requiredFields.company) {
                    console.log('[DEBUG] Showing company field');
                    document.getElementById('companyField').classList.remove('hidden');
                }

                // Handle additional questions from actual event settings
                const questions = event.questions || [];
                console.log('[DEBUG] Questions array:', questions);
                if (Array.isArray(questions) && questions.length > 0) {
                    console.log('[DEBUG] Processing questions');
                    const questionsContainer = document.getElementById('questionsContainer');
                    questionsContainer.innerHTML = '';
                    
                    questions.forEach((questionObj, index) => {
                        const questionDiv = document.createElement('div');
                        const requiredText = questionObj.required ? ' *' : '';
                        questionDiv.innerHTML = `
                            <label class="block text-[#A3B3AF] text-sm font-medium mb-2">${questionObj.text}${requiredText}</label>
                            <textarea id="question_${index}" class="w-full bg-[#19342e] border border-[#2C4A43] text-[#E0E0E0] rounded-lg px-4 py-3 focus:border-[#34D399] focus:ring-2 focus:ring-[#34D399] transition-colors resize-none" rows="3" placeholder="Your answer"></textarea>
                        `;
                        questionsContainer.appendChild(questionDiv);
                    });
                    document.getElementById('questionsSection').classList.remove('hidden');
                    console.log('[DEBUG] Questions section shown');
                } else {
                    document.getElementById('questionsSection').classList.add('hidden');
                    console.log('[DEBUG] No questions, hiding questions section');
                }

                // Show modal
                document.getElementById('bookingModal').classList.remove('hidden');
            }

            function closeBookingModal() {
                document.getElementById('bookingModal').classList.add('hidden');
                
                // Reset form fields to hidden
                document.getElementById('nameField').classList.add('hidden');
                document.getElementById('emailField').classList.add('hidden');
                document.getElementById('phoneField').classList.add('hidden');
                document.getElementById('companyField').classList.add('hidden');
                document.getElementById('questionsSection').classList.add('hidden');
                
                // Clear form values
                document.getElementById('bookingName').value = '';
                document.getElementById('bookingEmail').value = '';
                document.getElementById('bookingPhone').value = '';
                document.getElementById('bookingCompany').value = '';
                document.getElementById('questionsContainer').innerHTML = '';
            }

            function validateBookingForm() {
                const requiredFields = event.requiredFields || { name: false, email: false, phone: false, company: false };
                
                if (requiredFields.name && !document.getElementById('bookingName').value.trim()) {
                    alert('Please enter your name');
                    return false;
                }
                if (requiredFields.email && !document.getElementById('bookingEmail').value.trim()) {
                    alert('Please enter your email');
                    return false;
                }
                if (requiredFields.phone && !document.getElementById('bookingPhone').value.trim()) {
                    alert('Please enter your phone number');
                    return false;
                }
                if (requiredFields.company && !document.getElementById('bookingCompany').value.trim()) {
                    alert('Please enter your company name');
                    return false;
                }
                
                // Validate required custom questions
                const questions = event.questions || [];
                if (Array.isArray(questions) && questions.length > 0) {
                    for (let i = 0; i < questions.length; i++) {
                        const questionObj = questions[i];
                        if (questionObj.required) {
                            const answer = document.getElementById(`question_${i}`).value.trim();
                            if (!answer) {
                                alert(`Please answer the required question: ${questionObj.text}`);
                                return false;
                            }
                        }
                    }
                }
                
                return true;
            }

            async function confirmBooking() {
                if (!validateBookingForm()) return;

                // Collect form data
                const bookingData = {
                    eventTitle: event.title || event.name,
                    date: formatDate(selectedDate),
                    time: selectedTime,
                    duration: eventDuration,
                    name: document.getElementById('bookingName').value,
                    email: document.getElementById('bookingEmail').value,
                    phone: document.getElementById('bookingPhone').value,
                    company: document.getElementById('bookingCompany').value,
                    questions: []
                };

                // Collect question answers
                const questions = event.questions || [];
                if (Array.isArray(questions) && questions.length > 0) {
                    questions.forEach((questionObj, index) => {
                        const answer = document.getElementById(`question_${index}`).value;
                        bookingData.questions.push({ question: questionObj.text, answer });
                    });
                }

                const startDate = new Date(selectedDate);
                const { h, m } = parseTime(selectedTime);
                startDate.setHours(h, m, 0, 0);
                const endDate = new Date(startDate.getTime() + eventDuration * 60000);

                // Persist meeting to server
                try {
                    const res = await fetch(`${API_URL}/event-types/${event.slug}/bookings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: bookingData.name,
                            email: bookingData.email,
                            start: startDate.toISOString(),
                            end: endDate.toISOString()
                        })
                    });
                    console.log('Server booking response', res.status);
                } catch (e) { console.error('Booking API failed', e); }

                // Persist meeting to localStorage so host dashboard can display it
                const meeting = {
                    id: Date.now(),
                    invitee: bookingData.name || 'Anonymous',
                    email: bookingData.email || '',
                    eventType: bookingData.eventTitle,
                    date: `${bookingData.date}, ${bookingData.time}`,
                    status: 'Confirmed',
                    slug: event.slug
                };

                let meetingsObj;
                try {
                    meetingsObj = JSON.parse(localStorage.getItem('calendarify-meetings') || '{}');
                } catch {
                    meetingsObj = {};
                }
                if (!meetingsObj.upcoming) meetingsObj = { upcoming: [], past: [], pending: [] };
                meetingsObj.upcoming.push(meeting);
                localStorage.setItem('calendarify-meetings', JSON.stringify(meetingsObj));

                // Mark this slot as booked so it becomes unavailable
                let booked = {};
                try {
                    booked = JSON.parse(localStorage.getItem('calendarify-booked-slots') || '{}');
                } catch {}
                if (!booked[event.slug]) booked[event.slug] = [];
                booked[event.slug].push({
                    start: startDate.toISOString(),
                    end: endDate.toISOString(),
                    bufferBefore,
                    bufferAfter
                });
                localStorage.setItem('calendarify-booked-slots', JSON.stringify(booked));

                console.log('Booking confirmed:', bookingData);
                alert(`Booking confirmed for ${bookingData.date} at ${bookingData.time}!`);
                closeBookingModal();
            }

            // Event listeners
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                buildCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                buildCalendar();
            });

            document.getElementById('confirmButton').addEventListener('click', () => {
                if (selectedDate && selectedTime) {
                    showBookingModal();
                } else {
                    alert('Please select a date and time slot');
                }
            });

            document.getElementById('closeBookingModal').addEventListener('click', closeBookingModal);
            document.getElementById('cancelBooking').addEventListener('click', closeBookingModal);
            document.getElementById('confirmBooking').addEventListener('click', confirmBooking);

            // Close modal when clicking backdrop
            document.getElementById('bookingModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('bookingModal')) {
                    closeBookingModal();
                }
            });

            // Initialize the calendar
            buildCalendar();
        });
    </script>
</body>
</html>
